# Real-ESRGAN 推理流程图

## 整体流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           inference_realesrgan.py 入口                           │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 1. 参数解析                                                                      │
│    ├─ -i/--input     : 输入图片或文件夹路径                                       │
│    ├─ -o/--output    : 输出文件夹 (默认: results)                                │
│    ├─ -n/--model_name: 模型名称 (默认: RealESRGAN_x4plus)                        │
│    ├─ -s/--outscale  : 输出放大倍数 (默认: 4)                                    │
│    ├─ --fp32         : 使用FP32精度 (默认: FP16半精度)                           │
│    ├─ -t/--tile      : 分块大小，0为不分块 (默认: 0)                              │
│    └─ --face_enhance : 启用人脸增强                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 2. 模型初始化                                                                    │
│    ┌────────────────────────────────────────────────────────────────────────┐   │
│    │  根据 model_name 选择网络架构:                                          │   │
│    │  ┌─────────────────────┬─────────────────────────────────────────────┐ │   │
│    │  │ RealESRGAN_x4plus   │ RRDBNet(num_block=23, scale=4)              │ │   │
│    │  │ RealESRGAN_x2plus   │ RRDBNet(num_block=23, scale=2)              │ │   │
│    │  │ RealESRGAN_anime_6B │ RRDBNet(num_block=6, scale=4)               │ │   │
│    │  │ realesr-animevideov3│ SRVGGNetCompact(num_conv=16, scale=4)       │ │   │
│    │  └─────────────────────┴─────────────────────────────────────────────┘ │   │
│    └────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        ▼                                         │
│    ┌────────────────────────────────────────────────────────────────────────┐   │
│    │  创建 RealESRGANer 实例:                                                │   │
│    │  ├─ 加载预训练权重 (.pth文件)                                           │   │
│    │  ├─ 设置设备 (CUDA/CPU)                                                 │   │
│    │  ├─ 设置精度 (FP16/FP32)                                                │   │
│    │  └─ 配置tile参数                                                        │   │
│    └────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 3. 图像读取与模式检测                                                            │
│    ┌────────────────────────────────────────────────────────────────────────┐   │
│    │  cv2.imread(path, cv2.IMREAD_UNCHANGED)                                 │   │
│    │                        │                                                │   │
│    │                        ▼                                                │   │
│    │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│    │  │ 检测图像模式:                                                    │   │   │
│    │  │  • shape[2] == 4  →  RGBA (带透明通道)                          │   │   │
│    │  │  • shape[2] == 3  →  RGB                                        │   │   │
│    │  │  • len(shape) == 2 → Gray (灰度图)                              │   │   │
│    │  │  • max > 256      →  16-bit 图像                                │   │   │
│    │  └─────────────────────────────────────────────────────────────────┘   │   │
│    └────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 4. RealESRGANer.enhance() 核心处理流程                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
        ┌───────────────────────────────┼───────────────────────────────┐
        │                               │                               │
        ▼                               ▼                               ▼
┌───────────────────┐       ┌───────────────────┐       ┌───────────────────┐
│   RGB 通道处理     │       │   Alpha 通道处理   │       │  最终合并输出      │
│   (主图像内容)     │       │   (透明度信息)     │       │                   │
└───────────────────┘       └───────────────────┘       └───────────────────┘
        │                               │                               │
        ▼                               ▼                               │
┌───────────────────────────────────────────────────────────────┐       │
│                     处理子流程 (对RGB和Alpha分别执行)           │       │
│  ┌─────────────────────────────────────────────────────────┐  │       │
│  │ 4.1 pre_process() 预处理                                 │  │       │
│  │     ├─ 转换为Tensor: (H,W,C) → (1,C,H,W)                │  │       │
│  │     ├─ 归一化: img / 255.0                              │  │       │
│  │     ├─ 转移到GPU/CPU设备                                 │  │       │
│  │     ├─ pre_pad: 反射填充边界 (避免边缘伪影)              │  │       │
│  │     └─ mod_pad: 填充使尺寸可被scale整除                  │  │       │
│  └─────────────────────────────────────────────────────────┘  │       │
│                              │                                 │       │
│                              ▼                                 │       │
│  ┌─────────────────────────────────────────────────────────┐  │       │
│  │ 4.2 process() 或 tile_process() 模型推理                 │  │       │
│  │                                                          │  │       │
│  │     ┌──────────────┐         ┌───────────────────────┐  │  │       │
│  │     │ tile_size==0 │         │    tile_size > 0      │  │  │       │
│  │     │  整图处理    │         │     分块处理          │  │  │       │
│  │     └──────┬───────┘         └──────────┬────────────┘  │  │       │
│  │            │                            │               │  │       │
│  │            ▼                            ▼               │  │       │
│  │     ┌──────────────┐         ┌───────────────────────┐  │  │       │
│  │     │ output =     │         │ 1. 将图像分割成tiles  │  │  │       │
│  │     │ model(img)   │         │ 2. 每个tile加padding  │  │  │       │
│  │     │              │         │ 3. 逐个tile推理       │  │  │       │
│  │     │ 神经网络     │         │ 4. 去除padding        │  │  │       │
│  │     │ 前向传播     │         │ 5. 拼接所有tiles      │  │  │       │
│  │     └──────────────┘         └───────────────────────┘  │  │       │
│  └─────────────────────────────────────────────────────────┘  │       │
│                              │                                 │       │
│                              ▼                                 │       │
│  ┌─────────────────────────────────────────────────────────┐  │       │
│  │ 4.3 post_process() 后处理                                │  │       │
│  │     ├─ 移除 mod_pad 填充                                 │  │       │
│  │     ├─ 移除 pre_pad 填充                                 │  │       │
│  │     ├─ 转回numpy数组                                     │  │       │
│  │     ├─ clamp(0,1) 限制值范围                             │  │       │
│  │     └─ 通道重排: RGB → BGR                               │  │       │
│  └─────────────────────────────────────────────────────────┘  │       │
└───────────────────────────────────────────────────────────────┘       │
        │                               │                               │
        └───────────────────────────────┴───────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 5. 输出处理                                                                      │
│    ┌────────────────────────────────────────────────────────────────────────┐   │
│    │  if RGBA:                                                               │   │
│    │      output_img = cv2.cvtColor(output_img, COLOR_BGR2BGRA)             │   │
│    │      output_img[:,:,3] = output_alpha  # 合并Alpha通道                  │   │
│    │                                                                         │   │
│    │  if outscale != model_scale:                                           │   │
│    │      output = cv2.resize(output, ..., INTER_LANCZOS4)  # 额外缩放      │   │
│    │                                                                         │   │
│    │  output = (output * 255).round().astype(uint8)  # 反归一化             │   │
│    └────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 6. 保存结果                                                                      │
│    cv2.imwrite(save_path, output)                                               │
│    保存到: {output_folder}/{imgname}_{suffix}.{extension}                       │
└─────────────────────────────────────────────────────────────────────────────────┘


## 神经网络内部结构 (RRDBNet)

```
输入 (1, 3, H, W)
       │
       ▼
┌─────────────────┐
│ Conv2d 3→64     │  第一层卷积，扩展通道
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                    RRDB Block × 23                          │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  Residual in Residual Dense Block                      │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │  Dense Block × 3                                  │  │ │
│  │  │  ┌────────────────────────────────────────────┐  │  │ │
│  │  │  │ Conv → LeakyReLU → 密集连接                │  │  │ │
│  │  │  │ 每层输出与之前所有层拼接                    │  │  │ │
│  │  │  └────────────────────────────────────────────┘  │  │ │
│  │  │         + 残差连接 (×0.2)                         │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  │         + 残差连接 (×0.2)                              │ │
│  └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ Conv2d 64→64    │
│ + 残差连接      │  trunk_conv
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                    上采样模块 (4x)                           │
│  ┌─────────────────┐   ┌─────────────────┐                  │
│  │ Conv + Upsample │ → │ Conv + Upsample │  2次2x上采样     │
│  │  (nearest ×2)   │   │  (nearest ×2)   │  = 4x放大        │
│  └─────────────────┘   └─────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ Conv → LeakyReLU│
│ Conv 64→3      │  输出层
└────────┬────────┘
         │
         ▼
输出 (1, 3, H×4, W×4)
```


## Tile 分块处理详细流程

```
原始图像 (H × W)
┌─────────────────────────────┐
│                             │
│    ┌─────┐ ┌─────┐ ┌─────┐  │
│    │tile0│ │tile1│ │tile2│  │
│    │+pad │ │+pad │ │+pad │  │
│    └─────┘ └─────┘ └─────┘  │
│    ┌─────┐ ┌─────┐ ┌─────┐  │
│    │tile3│ │tile4│ │tile5│  │
│    │+pad │ │+pad │ │+pad │  │
│    └─────┘ └─────┘ └─────┘  │
│                             │
└─────────────────────────────┘

处理步骤:
1. tiles_x = ceil(W / tile_size)
2. tiles_y = ceil(H / tile_size)
3. for each tile:
   ├─ 提取 tile + padding 区域
   ├─ model(tile) 推理
   ├─ 去除 padding 部分
   └─ 放入输出图像对应位置
4. 所有 tiles 拼接成完整输出

优点: 可处理超大图像，避免显存不足
缺点: 可能在tile边界产生轻微接缝
```
